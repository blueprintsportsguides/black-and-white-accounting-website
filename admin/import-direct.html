<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Import - Blog Admin | Black and White Accounting</title>
    <link rel="icon" type="image/png" href="../Images/circle logo.png">
    <link rel="stylesheet" href="../styles.css">
    <style>
        .admin-header {
            background: white;
            border-bottom: 2px solid #e5e7eb;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        .admin-header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }
        .admin-title {
            font-size: var(--font-size-2xl);
            font-weight: 700;
        }
        .admin-actions {
            display: flex;
            gap: var(--spacing-md);
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-sm);
            text-decoration: none;
            font-weight: 600;
        }
        .import-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 var(--spacing-lg);
        }
        .import-section {
            background: white;
            border-radius: var(--radius-md);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-lg);
        }
        .btn-primary {
            background: var(--text-primary);
            color: white;
            padding: var(--spacing-md) var(--spacing-xl);
            border-radius: var(--radius-sm);
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: var(--font-size-base);
            width: 100%;
            margin-top: var(--spacing-md);
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .log-output {
            background: #1a1a1a;
            color: #00ff00;
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: var(--font-size-sm);
            max-height: 500px;
            overflow-y: auto;
            margin-top: var(--spacing-lg);
            display: none;
        }
        .log-output.active {
            display: block;
        }
        .log-output pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            margin-top: var(--spacing-lg);
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="admin-header-content">
            <h1 class="admin-title">Direct Import from JSON</h1>
            <div class="admin-actions">
                <a href="blog.html" class="btn-secondary">← Back to Posts</a>
            </div>
        </div>
    </div>

    <div class="import-container">
        <div class="import-section">
            <h2>Import JSON File</h2>
            <p>Select a JSON import file generated by the WordPress import script. Files are located in the <code>data/</code> folder.</p>
            
            <div class="file-input-wrapper" style="margin-bottom: var(--spacing-lg);">
                <label for="json-file" style="display: block; padding: var(--spacing-md); border: 2px dashed #e5e7eb; border-radius: var(--radius-sm); background: #f9fafb; cursor: pointer; text-align: center; transition: all 0.2s;">
                    <input type="file" id="json-file" accept=".json" style="display: none;" />
                    <span id="file-label">Click to select JSON import file (from data/ folder)</span>
                </label>
            </div>
            
            <button class="btn-primary" id="import-btn" disabled>Import JSON File</button>
            <div class="log-output" id="log-output">
                <pre id="log-content"></pre>
            </div>
            <div id="success-message" class="success-message" style="display: none;"></div>
        </div>
    </div>

    <script type="module">
        import { requireAuth } from '../admin-auth.js';
        import { importFromJSON } from '../scripts/import-json-to-localstorage.js';
        import { getAllPosts, savePost } from '../blog-data.js';

        // Require authentication
        if (!requireAuth()) {
            throw new Error('Not authenticated');
        }

        const fileInput = document.getElementById('json-file');
        const fileLabel = document.getElementById('file-label');
        const importBtn = document.getElementById('import-btn');
        const logOutput = document.getElementById('log-output');
        const logContent = document.getElementById('log-content');
        const successMessage = document.getElementById('success-message');

        let importData = null;

        // File selection handler
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                fileLabel.textContent = `Selected: ${file.name}`;
                importBtn.disabled = false;

                // Read file
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        importData = JSON.parse(event.target.result);
                        console.log(`File loaded: ${importData.posts?.length || 0} posts, ${importData.categories?.length || 0} categories, ${importData.tags?.length || 0} tags`);
                    } catch (error) {
                        console.error('Error parsing JSON file: ' + error.message);
                        importBtn.disabled = true;
                        fileLabel.textContent = 'Error: Invalid JSON file';
                        importData = null;
                    }
                };
                reader.onerror = function() {
                    console.error('Error reading file');
                    importBtn.disabled = true;
                    fileLabel.textContent = 'Error: Could not read file';
                    importData = null;
                };
                reader.readAsText(file);
            } else {
                fileLabel.textContent = 'Click to select JSON import file (from data/ folder)';
                importBtn.disabled = true;
                importData = null;
            }
        });
        
        // Also allow clicking the label text
        fileLabel.addEventListener('click', function(e) {
            e.preventDefault();
            fileInput.click();
        });

        // Override console.log to capture output
        const originalLog = console.log;
        const originalError = console.error;
        const logs = [];

        function addLog(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : '✓';
            logs.push(`[${timestamp}] ${prefix} ${message}`);
            logContent.textContent = logs.join('\n');
            logOutput.classList.add('active');
            logContent.scrollTop = logContent.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLog(args.join(' '), 'error');
        };

        importBtn.addEventListener('click', async function() {
            if (!importData) {
                console.error('Please select a JSON file first');
                return;
            }

            importBtn.disabled = true;
            importBtn.textContent = 'Importing...';
            logs.length = 0;
            logContent.textContent = '';
            successMessage.style.display = 'none';

            try {
                const jsonData = importData;
                console.log(`Loaded JSON file with ${jsonData.posts?.length || 0} posts`);

                // Import the data
                const stats = await importFromJSON(jsonData);

                // Auto-publish imported posts
                const allPosts = getAllPosts();
                const importedPosts = allPosts.filter(p => p.legacy_wp_id && p.status === 'draft');
                let publishedCount = 0;

                importedPosts.forEach(post => {
                    const updatedPost = {
                        ...post,
                        status: 'published',
                        published_at: post.published_at || post.created_at || new Date().toISOString()
                    };
                    savePost(updatedPost);
                    publishedCount++;
                });

                // Show success message
                successMessage.innerHTML = `
                    <h3>Import Complete!</h3>
                    <p><strong>${stats.postsImported}</strong> posts imported</p>
                    <p><strong>${stats.postsUpdated}</strong> posts updated</p>
                    <p><strong>${publishedCount}</strong> posts automatically published</p>
                    <p><strong>${stats.categoriesCreated}</strong> categories created</p>
                    <p><strong>${stats.tagsCreated}</strong> tags created</p>
                    ${stats.errors.length > 0 ? `<p><strong>${stats.errors.length}</strong> errors occurred</p>` : ''}
                    <p><a href="../blog.html">View blog →</a> | <a href="blog.html">View all posts →</a></p>
                `;
                successMessage.style.display = 'block';

            } catch (error) {
                console.error('Import failed: ' + error.message);
                successMessage.innerHTML = `<strong>Error:</strong> ${error.message}`;
                successMessage.style.backgroundColor = '#fee2e2';
                successMessage.style.color = '#991b1b';
                successMessage.style.display = 'block';
            } finally {
                importBtn.disabled = false;
                importBtn.textContent = 'Import JSON File';
            }
        });
    </script>
</body>
</html>

