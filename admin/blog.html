<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Admin - Insights | Black and White Accounting</title>
    <link rel="icon" type="image/png" href="/Images/circle logo.png">
    <link rel="stylesheet" href="/styles.css">
    <style>
        .admin-header {
            background: white;
            border-bottom: 2px solid #e5e7eb;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        .admin-header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }
        .admin-title {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--text-primary);
        }
        .admin-actions {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }
        .btn-new-post {
            background: var(--text-primary);
            color: white;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-sm);
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        .btn-logout {
            background: #dc2626;
            color: white;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-sm);
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--spacing-lg);
        }
        .admin-filters {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        .filter-group label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 600;
            font-size: var(--font-size-sm);
        }
        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: var(--spacing-sm);
            border: 2px solid #e5e7eb;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-base);
        }
        .posts-table {
            background: white;
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .table-header {
            background: #f9fafb;
            padding: var(--spacing-md);
            display: grid;
            grid-template-columns: 40px 2fr 1fr 1fr 1fr 120px;
            gap: var(--spacing-md);
            font-weight: 600;
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            border-bottom: 2px solid #e5e7eb;
        }
        .table-row {
            padding: var(--spacing-md);
            display: grid;
            grid-template-columns: 40px 2fr 1fr 1fr 1fr 120px;
            gap: var(--spacing-md);
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            transition: background 0.2s;
        }
        .bulk-actions-bar {
            display: none;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }
        .bulk-actions-bar.visible {
            display: flex;
        }
        .bulk-actions-bar span {
            font-weight: 600;
            font-size: var(--font-size-sm);
        }
        .bulk-actions-bar select {
            padding: 6px 10px;
            border: 2px solid #e5e7eb;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
        }
        .bulk-actions-bar .btn-bulk {
            padding: 6px 14px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-weight: 600;
            cursor: pointer;
        }
        .btn-bulk-category { background: #3b82f6; color: white; }
        .btn-bulk-publish { background: #059669; color: white; }
        .btn-bulk-unpublish { background: #6b7280; color: white; }
        .btn-bulk-delete { background: #dc2626; color: white; }
        .btn-bulk-clear { background: #e5e7eb; color: #374151; }
        .table-row:hover {
            background: #f9fafb;
        }
        .table-row:last-child {
            border-bottom: none;
        }
        .post-title {
            font-weight: 600;
            color: var(--text-primary);
        }
        .post-title a {
            color: inherit;
            text-decoration: none;
        }
        .post-title a:hover {
            text-decoration: underline;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: var(--font-size-sm);
            font-weight: 600;
        }
        .status-draft {
            background: #fef3c7;
            color: #92400e;
        }
        .status-scheduled {
            background: #dbeafe;
            color: #1e40af;
        }
        .status-published {
            background: #d1fae5;
            color: #065f46;
        }
        .table-actions {
            display: flex;
            gap: var(--spacing-xs);
        }
        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            cursor: pointer;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        .btn-action:hover {
            opacity: 0.8;
        }
        .btn-edit {
            background: #3b82f6;
            color: white;
        }
        .btn-delete {
            background: #dc2626;
            color: white;
        }
        .empty-state {
            text-align: center;
            padding: var(--spacing-3xl);
            color: var(--text-secondary);
        }
        .empty-state h3 {
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }
        @media (max-width: 768px) {
            .table-header,
            .table-row {
                grid-template-columns: 1fr;
                gap: var(--spacing-xs);
            }
            .table-header {
                display: none;
            }
            .table-row {
                border: 1px solid #e5e7eb;
                border-radius: var(--radius-sm);
                margin-bottom: var(--spacing-md);
                padding: var(--spacing-md);
            }
            .table-actions {
                margin-top: var(--spacing-sm);
            }
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="admin-header-content">
            <h1 class="admin-title">Insights Blog Admin</h1>
            <div class="admin-actions">
                <a href="index.html" class="btn-secondary" style="background: #4b5563; color: white; padding: var(--spacing-sm) var(--spacing-lg); border-radius: var(--radius-sm); text-decoration: none; font-weight: 600;">Admin Hub</a>
                <a href="import.html" class="btn-secondary" style="background: #6b7280; color: white; padding: var(--spacing-sm) var(--spacing-lg); border-radius: var(--radius-sm); text-decoration: none; font-weight: 600;">Import WordPress</a>
                <a href="../import-json-to-supabase.html" class="btn-secondary" style="background: #7c3aed; color: white; padding: var(--spacing-sm) var(--spacing-lg); border-radius: var(--radius-sm); text-decoration: none; font-weight: 600;">Import JSON to Supabase</a>
                <button id="export-json-btn" class="btn-secondary" style="background: #2563eb; color: white; padding: var(--spacing-sm) var(--spacing-lg); border-radius: var(--radius-sm); border: none; font-weight: 600; cursor: pointer;">Export JSON</button>
                <a href="publish-all.html" class="btn-secondary" style="background: #059669; color: white; padding: var(--spacing-sm) var(--spacing-lg); border-radius: var(--radius-sm); text-decoration: none; font-weight: 600;">Publish All</a>
                <a href="wipe-imported.html" class="btn-secondary" style="background: #dc2626; color: white; padding: var(--spacing-sm) var(--spacing-lg); border-radius: var(--radius-sm); text-decoration: none; font-weight: 600;">Wipe Imported</a>
                <a href="blog/new.html" class="btn-new-post">+ New Post</a>
                <button class="btn-logout" id="logout-btn">Logout</button>
            </div>
        </div>
    </div>

    <div class="admin-container">
        <div class="admin-filters">
            <div class="filter-group">
                <label for="search-input">Search</label>
                <input type="text" id="search-input" placeholder="Search posts...">
            </div>
            <div class="filter-group">
                <label for="status-filter">Status</label>
                <select id="status-filter">
                    <option value="">All Statuses</option>
                    <option value="draft">Draft</option>
                    <option value="scheduled">Scheduled</option>
                    <option value="published">Published</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="category-filter">Category</label>
                <select id="category-filter">
                    <option value="">All Categories</option>
                </select>
            </div>
        </div>

        <div id="bulk-actions-bar" class="bulk-actions-bar">
            <span id="bulk-count">0 selected</span>
            <select id="bulk-category">
                <option value="">Set categoryâ€¦</option>
            </select>
            <button type="button" class="btn-bulk btn-bulk-category" id="bulk-apply-category">Apply category</button>
            <button type="button" class="btn-bulk btn-bulk-publish" id="bulk-publish">Publish</button>
            <button type="button" class="btn-bulk btn-bulk-unpublish" id="bulk-unpublish">Unpublish</button>
            <button type="button" class="btn-bulk btn-bulk-delete" id="bulk-delete">Delete</button>
            <button type="button" class="btn-bulk btn-bulk-clear" id="bulk-clear">Clear</button>
        </div>

        <div class="posts-table" id="posts-table">
            <div class="table-header">
                <div><input type="checkbox" id="select-all-cb" title="Select all"></div>
                <div>Title</div>
                <div>Status</div>
                <div>Category</div>
                <div>Published</div>
                <div>Actions</div>
            </div>
            <div id="posts-list"></div>
        </div>
    </div>

    <script type="module">
        import { requireAuth, clearAuthentication } from '/admin-auth.js';
        import { ensureDataLoaded, getAllPosts, getPostById, savePost, deletePost, searchPosts, getCategories, formatDate, downloadJSON } from '/blog-data.js';

        (async () => {
        if (!(await requireAuth())) return;

        // Wait for data to load
        await ensureDataLoaded();

        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', async function() {
            if (confirm('Are you sure you want to logout?')) {
                await clearAuthentication();
                window.location.href = '/admin-login';
            }
        });

        // Export JSON handler
        document.getElementById('export-json-btn').addEventListener('click', function() {
            try {
                downloadJSON();
                alert('JSON file downloaded! Replace data/blog-posts.json with this file and commit to git to persist your changes.');
            } catch (error) {
                alert('Error exporting JSON: ' + error.message);
                console.error('Export error:', error);
            }
        });

        // Load categories
        const categories = await getCategories();
        const categorySelect = document.getElementById('category-filter');
        const bulkCategorySelect = document.getElementById('bulk-category');
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.name;
            categorySelect.appendChild(option);
            const bulkOpt = document.createElement('option');
            bulkOpt.value = cat.id;
            bulkOpt.textContent = cat.name;
            bulkCategorySelect.appendChild(bulkOpt);
        });

        // Render posts
        async function renderPosts() {
            const searchQuery = document.getElementById('search-input').value;
            const statusFilter = document.getElementById('status-filter').value;
            const categoryFilter = document.getElementById('category-filter').value;

            const posts = await searchPosts(searchQuery, {
                status: statusFilter || undefined,
                category: categoryFilter || undefined,
                includeAll: true // Admin sees all posts including drafts
            });

            const postsList = document.getElementById('posts-list');
            
            if (posts.length === 0) {
                postsList.innerHTML = `
                    <div class="empty-state">
                        <h3>No posts found</h3>
                        <p>${searchQuery || statusFilter || categoryFilter ? 'Try adjusting your filters.' : 'Create your first blog post to get started.'}</p>
                    </div>
                `;
                updateBulkBar();
                return;
            }

            postsList.innerHTML = posts.map(post => {
                const category = categories.find(c => c.id === post.category_id);
                const statusClass = `status-${post.status}`;
                const publishedDate = post.published_at ? formatDate(post.published_at) : 'Not published';
                
                return `
                    <div class="table-row">
                        <div><input type="checkbox" class="post-select-cb" data-id="${post.id}"></div>
                        <div class="post-title">
                            <a href="blog/edit.html?id=${post.id}">${post.title || 'Untitled'}</a>
                        </div>
                        <div>
                            <span class="status-badge ${statusClass}">${post.status || 'draft'}</span>
                        </div>
                        <div>${category ? category.name : 'Uncategorized'}</div>
                        <div>${publishedDate}</div>
                        <div class="table-actions">
                            <button class="btn-action btn-edit" onclick="window.location.href='blog/edit.html?id=${post.id}'">Edit</button>
                            <button class="btn-action btn-delete" onclick="handleDelete('${post.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
            updateBulkBar();
        }

        // Delete handler
        window.handleDelete = async function(postId) {
            if (confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                await deletePost(postId);
                await renderPosts();
            }
        };

        function getSelectedIds() {
            return Array.from(document.querySelectorAll('.post-select-cb:checked')).map(cb => cb.dataset.id);
        }

        function updateBulkBar() {
            const ids = getSelectedIds();
            const bar = document.getElementById('bulk-actions-bar');
            const countEl = document.getElementById('bulk-count');
            const selectAll = document.getElementById('select-all-cb');
            const total = document.querySelectorAll('.post-select-cb').length;
            countEl.textContent = ids.length + ' selected';
            bar.classList.toggle('visible', ids.length > 0);
            selectAll.checked = total > 0 && ids.length === total;
            selectAll.indeterminate = ids.length > 0 && ids.length < total;
        }

        function clearSelection() {
            document.querySelectorAll('.post-select-cb').forEach(cb => { cb.checked = false; });
            document.getElementById('select-all-cb').checked = false;
            updateBulkBar();
        }

        document.getElementById('select-all-cb').addEventListener('change', function() {
            document.querySelectorAll('.post-select-cb').forEach(cb => { cb.checked = this.checked; });
            updateBulkBar();
        });

        document.getElementById('posts-list').addEventListener('change', function(e) {
            if (e.target.classList.contains('post-select-cb')) updateBulkBar();
        });

        document.getElementById('bulk-apply-category').addEventListener('click', async function() {
            const ids = getSelectedIds();
            const catId = document.getElementById('bulk-category').value;
            if (!catId) { alert('Please choose a category'); return; }
            for (const id of ids) {
                const p = await getPostById(id);
                if (p) await savePost({ ...p, category_id: catId });
            }
            clearSelection();
            await renderPosts();
        });

        document.getElementById('bulk-publish').addEventListener('click', async function() {
            for (const id of getSelectedIds()) {
                const p = await getPostById(id);
                if (p) await savePost({ ...p, status: 'published', published_at: p.published_at || new Date().toISOString() });
            }
            clearSelection();
            await renderPosts();
        });

        document.getElementById('bulk-unpublish').addEventListener('click', async function() {
            for (const id of getSelectedIds()) {
                const p = await getPostById(id);
                if (p) await savePost({ ...p, status: 'draft' });
            }
            clearSelection();
            await renderPosts();
        });

        document.getElementById('bulk-delete').addEventListener('click', async function() {
            const ids = getSelectedIds();
            if (!ids.length) return;
            if (!confirm('Delete ' + ids.length + ' post(s)? This cannot be undone.')) return;
            for (const id of ids) {
                await deletePost(id);
            }
            clearSelection();
            await renderPosts();
        });

        document.getElementById('bulk-clear').addEventListener('click', clearSelection);

        // Filter handlers (debounced)
        let filterTimeout;
        function debouncedRender() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => renderPosts(), 150);
        }
        document.getElementById('search-input').addEventListener('input', debouncedRender);
        document.getElementById('status-filter').addEventListener('change', () => renderPosts());
        document.getElementById('category-filter').addEventListener('change', () => renderPosts());

        // Initial render
        await renderPosts();
        })();
    </script>
</body>
</html>

