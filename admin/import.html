<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import WordPress Posts - Blog Admin | Black and White Accounting</title>
    <link rel="icon" type="image/png" href="/Images/circle logo.png">
    <link rel="stylesheet" href="/styles.css">
    <style>
        .admin-header {
            background: white;
            border-bottom: 2px solid #e5e7eb;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        .admin-header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }
        .admin-title {
            font-size: var(--font-size-2xl);
            font-weight: 700;
        }
        .admin-actions {
            display: flex;
            gap: var(--spacing-md);
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-sm);
            text-decoration: none;
            font-weight: 600;
        }
        .import-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 var(--spacing-lg);
        }
        .import-section {
            background: white;
            border-radius: var(--radius-md);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-lg);
        }
        .import-section h2 {
            margin-bottom: var(--spacing-md);
        }
        .import-section p {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-lg);
        }
        .file-input-wrapper {
            position: relative;
            margin-bottom: var(--spacing-lg);
        }
        .file-input {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px dashed #e5e7eb;
            border-radius: var(--radius-sm);
            background: #f9fafb;
            cursor: pointer;
            text-align: center;
        }
        .file-input:hover {
            border-color: var(--text-primary);
            background: #f3f4f6;
        }
        .file-input input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .btn-primary {
            background: var(--text-primary);
            color: white;
            padding: var(--spacing-md) var(--spacing-xl);
            border-radius: var(--radius-sm);
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: var(--font-size-base);
            width: 100%;
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: var(--spacing-lg) 0;
            display: none;
        }
        .progress-bar.active {
            display: block;
        }
        .progress-fill {
            height: 100%;
            background: var(--text-primary);
            width: 0%;
            transition: width 0.3s;
        }
        .import-log {
            background: #f9fafb;
            border-radius: var(--radius-sm);
            padding: var(--spacing-md);
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: var(--font-size-sm);
            display: none;
        }
        .import-log.active {
            display: block;
        }
        .import-log pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }
        .stat-card {
            background: #f9fafb;
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            text-align: center;
        }
        .stat-value {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--text-primary);
        }
        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
        }
        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            margin-top: var(--spacing-lg);
        }
        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            margin-top: var(--spacing-lg);
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="admin-header-content">
            <h1 class="admin-title">Import WordPress Posts</h1>
            <div class="admin-actions">
                <a href="/admin/blog" class="btn-secondary">← Back to Posts</a>
            </div>
        </div>
    </div>

    <div class="import-container">
        <div class="import-section">
            <h2>Import from JSON File</h2>
            <p>Upload a JSON file generated by the WordPress import script. This will import all posts, categories, and tags into the blog system.</p>
            
            <div class="file-input-wrapper">
                <div class="file-input">
                    <input type="file" id="json-file" accept=".json" />
                    <div id="file-label">Click to select JSON import file</div>
                </div>
            </div>

            <button class="btn-primary" id="import-btn" disabled>Import Posts</button>

            <div class="progress-bar" id="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>

            <div class="import-log" id="import-log">
                <pre id="log-content"></pre>
            </div>

            <div id="summary-container" style="display: none;">
                <div class="summary-stats" id="summary-stats"></div>
                <div id="success-message" class="success-message" style="display: none;"></div>
                <div id="error-message" class="error-message" style="display: none;"></div>
            </div>
        </div>

        <div class="import-section">
            <h2>Instructions</h2>
            <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: var(--spacing-md); margin-bottom: var(--spacing-lg); border-radius: var(--radius-sm);">
                <strong>⚠️ Important:</strong> Blog data is stored in your browser's localStorage. Data imported on your local development machine will <strong>not</strong> appear in production. You must import the JSON file again on the production site for the posts to appear publicly.
            </div>
            <ol style="line-height: 1.8;">
                <li>Run the WordPress import script to generate a JSON file:
                    <pre style="background: #f3f4f6; padding: var(--spacing-sm); border-radius: var(--radius-sm); margin: var(--spacing-sm) 0;">npm run import:dry-run  # Test first
npm run import           # Generate import file</pre>
                </li>
                <li>The script will create a file in <code>data/wp-import-*.json</code></li>
                <li>Upload that JSON file using the form above</li>
                <li>Click "Import Posts" to import all posts, categories, and tags</li>
                <li>Existing posts with the same <code>legacy_wp_id</code> will be updated</li>
            </ol>
        </div>
    </div>

    <script type="module">
        import { requireAuth } from '/admin-auth.js';
        import { savePost, saveCategory, saveTag, getCategories, getTags, getAllPosts } from '/blog-data.js';

        (async () => {
        if (!(await requireAuth())) return;

        const fileInput = document.getElementById('json-file');
        const fileLabel = document.getElementById('file-label');
        const importBtn = document.getElementById('import-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressFill = document.getElementById('progress-fill');
        const importLog = document.getElementById('import-log');
        const logContent = document.getElementById('log-content');
        const summaryContainer = document.getElementById('summary-container');
        const summaryStats = document.getElementById('summary-stats');
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');

        let importData = null;

        // File selection handler
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Show loading state
                fileLabel.textContent = `Loading: ${file.name}...`;
                fileLabel.style.color = '#6b7280';
                importBtn.disabled = true;
                importLog.classList.add('active');
                log(`Reading file: ${file.name} (${(file.size / 1024).toFixed(2)} KB)...`);

                // Read file
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        importData = JSON.parse(e.target.result);
                        const postCount = importData.posts?.length || 0;
                        const catCount = importData.categories?.length || 0;
                        const tagCount = importData.tags?.length || 0;
                        
                        fileLabel.textContent = `✓ Loaded: ${file.name}`;
                        fileLabel.style.color = '#059669';
                        importBtn.disabled = false;
                        log(`✓ File loaded successfully: ${postCount} posts, ${catCount} categories, ${tagCount} tags`);
                        log('Ready to import. Click "Import Posts" button to proceed.');
                    } catch (error) {
                        fileLabel.textContent = `✗ Error: ${file.name}`;
                        fileLabel.style.color = '#dc2626';
                        showError('Error parsing JSON file: ' + error.message);
                        log(`✗ Error parsing JSON: ${error.message}`);
                        importBtn.disabled = true;
                        importData = null;
                    }
                };
                reader.onerror = function() {
                    fileLabel.textContent = `✗ Error reading: ${file.name}`;
                    fileLabel.style.color = '#dc2626';
                    showError('Error reading file. Please try again.');
                    log('✗ Error reading file');
                    importBtn.disabled = true;
                    importData = null;
                };
                reader.readAsText(file);
            } else {
                fileLabel.textContent = 'Click to select JSON import file';
                fileLabel.style.color = '';
                importBtn.disabled = true;
                importData = null;
            }
        });

        // Logging function
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logContent.textContent += `[${timestamp}] ${message}\n`;
            importLog.classList.add('active');
            logContent.scrollTop = logContent.scrollHeight;
        }

        function updateProgress(percent) {
            progressFill.style.width = percent + '%';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        // Import handler
        importBtn.addEventListener('click', async function() {
            if (!importData) {
                showError('Please select a JSON file first');
                return;
            }

            importBtn.disabled = true;
            progressBar.classList.add('active');
            updateProgress(0);
            log('Starting import...');

            const stats = {
                postsImported: 0,
                postsUpdated: 0,
                categoriesCreated: 0,
                tagsCreated: 0,
                errors: []
            };

            try {
                // Import categories
                log(`Importing ${importData.categories?.length || 0} categories...`);
                const existingCategories = getCategories();
                const existingCategorySlugs = new Set(existingCategories.map(c => c.slug));

                for (const cat of importData.categories || []) {
                    if (!existingCategorySlugs.has(cat.slug)) {
                        saveCategory(cat);
                        stats.categoriesCreated++;
                        log(`Created category: ${cat.name}`);
                    }
                }
                updateProgress(20);

                // Import tags
                log(`Importing ${importData.tags?.length || 0} tags...`);
                const existingTags = getTags();
                const existingTagSlugs = new Set(existingTags.map(t => t.slug));

                for (const tag of importData.tags || []) {
                    if (!existingTagSlugs.has(tag.slug)) {
                        saveTag(tag);
                        stats.tagsCreated++;
                        log(`Created tag: ${tag.name}`);
                    }
                }
                updateProgress(40);

                // Import posts
                log(`Importing ${importData.posts?.length || 0} posts...`);
                const existingPosts = getAllPosts();
                const existingLegacyIds = new Set(existingPosts.map(p => p.legacy_wp_id).filter(Boolean));

                // Map category slugs to IDs
                const allCategories = getCategories();
                const categoryMap = new Map();
                allCategories.forEach(cat => {
                    categoryMap.set(cat.slug, cat.id);
                });

                // Map tag slugs to IDs
                const allTags = getTags();
                const tagMap = new Map();
                allTags.forEach(tag => {
                    tagMap.set(tag.slug, tag.id);
                });

                for (let i = 0; i < importData.posts.length; i++) {
                    const post = importData.posts[i];
                    
                    try {
                        // Convert category slug to ID
                        if (post.category_slug) {
                            post.category_id = categoryMap.get(post.category_slug) || null;
                        }

                        // Convert tag slugs to IDs
                        if (post.tag_slugs && Array.isArray(post.tag_slugs)) {
                            post.tags = post.tag_slugs
                                .map(slug => tagMap.get(slug))
                                .filter(id => id !== undefined);
                        }

                        // Check if updating existing
                        const isUpdate = existingLegacyIds.has(post.legacy_wp_id);
                        
                        savePost(post);
                        
                        if (isUpdate) {
                            stats.postsUpdated++;
                            log(`Updated post: ${post.title}`);
                        } else {
                            stats.postsImported++;
                            log(`Imported post: ${post.title}`);
                        }

                        updateProgress(40 + (i + 1) / importData.posts.length * 50);
                    } catch (error) {
                        stats.errors.push({ post: post.title, error: error.message });
                        log(`Error importing post "${post.title}": ${error.message}`);
                    }
                }

                updateProgress(100);
                log('Import complete!');

                // Show summary
                summaryContainer.style.display = 'block';
                summaryStats.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.postsImported}</div>
                        <div class="stat-label">Posts Imported</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.postsUpdated}</div>
                        <div class="stat-label">Posts Updated</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.categoriesCreated}</div>
                        <div class="stat-label">Categories Created</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.tagsCreated}</div>
                        <div class="stat-label">Tags Created</div>
                    </div>
                `;

                if (stats.errors.length > 0) {
                    showError(`${stats.errors.length} errors occurred during import. Check the log for details.`);
                } else {
                    showSuccess(`Successfully imported ${stats.postsImported} posts and updated ${stats.postsUpdated} existing posts!`);
                }

            } catch (error) {
                showError('Import failed: ' + error.message);
                log('Error: ' + error.message);
            } finally {
                importBtn.disabled = false;
            }
        });
        })();
    </script>
</body>
</html>

